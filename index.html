<!doctype html> 
<html> 
<head> 
    <meta http-equiv="content-type" content="text/html; charset=utf-8" /> 
    <meta name="keywords" content="天地图山东" /> 
    <title>天地图－地图API－范例－WMS-C图层加载</title> 
    <script src="http://www.sdmap.gov.cn/api/olapi/js/jquery-1.6.4.min.js"></script> 
    <!--[if lt IE 9]> 
    <script src="http://www.sdmap.gov.cn/api/olapi/js/html5.js"></script> 
    <![endif]--> 
    <script type="text/javascript" src="http://www.sdmap.gov.cn/api/olapi/ol/openlayers.js"></script> 
    <style type="text/css"> 
        body{width: 100%;height: 100%;position: absolute;margin: 0;} 
        #outter{height: 100%} 
        #mapDiv{height: 100%;width: 100%} 
        #reback{position: absolute;bottom: 10px;right: 100px;z-index: 1002;} 
        #reback a{background-color: #7D7D7D; padding: 10px;color: #FFF;} 
        .pic {width: 1760px;height: 480px}
    </style>
</head> 
<body> 
    <div id="outter"> 
        <div id="mapDiv"> 
        </div> 
    </div>
    <img id="pic" style="display:none;position:absolute;left:-200px;top:0;z-index:999999" class="pic" src="img/cad2.png"/>
    <script type="text/javascript" src="script/coordinateData.js"></script>  
    <script type="text/javascript" id="codetoshow"> 
    //定义地图对象 
    var map; 
    var sdannoLayer = new SDRSAnnoLayer();
    var sdimgLayer = new SDRasterLayer(); 
    $(function () { 
        map = new OpenLayers.Map("mapDiv", { 
            allOverlays: true, 
            numZoomLevels: 19, 
            displayProjection: "EPSG:4490", 
            controls: [ 
            new OpenLayers.Control.Navigation(),
            new OpenLayers.Control.Zoom(), 
            new OpenLayers.Control.ArgParser(), 
            new OpenLayers.Control.Attribution()] 
        }); 
        map.addLayer(sdimgLayer); 
        map.addLayer(sdannoLayer); ;
        map.setCenter(new OpenLayers.LonLat(117.93341, 37.67119), 16); 
        //添加矢量图层
        var graphicLayer = new OpenLayers.Layer.Vector("graphicLayer",
            { style: OpenLayers.Util.extend({}, OpenLayers.Feature.Vector.style['default']) });
        map.addLayer(graphicLayer);
        // 总管
        var zgCoordinates = [
            [{lon: 117.91929,lat: 37.66426}, {lon: 117.94504,lat: 37.66707}],
             [{lon: 117.92451,lat: 37.67027}, {lon: 117.94631,lat: 37.67374}]
        ];
        var zgStyle = {
            strokeColor: '#271ed9',
            strokeWidth: 8,
        };
        for(var i = 0; i < zgCoordinates.length; i++) {
            var lineStringArray = [];
            for(var j = 0; j < zgCoordinates[i].length; j++) {
                lineStringArray.push(
                    new OpenLayers.Geometry.Point(zgCoordinates[i][j].lon, zgCoordinates[i][j].lat)
                );
            }
            var line = new OpenLayers.Geometry.LineString(lineStringArray); 
            var feature = new OpenLayers.Feature.Vector(line, {i}, zgStyle);
            graphicLayer.addFeatures([feature]);
        }

        
        var lineStyle = {
            strokeColor: '#cfcfcf',
            strokeWidth: 5,
        };
        var lineFeatureArray = [];
        for(var i = 0; i < lineCoordinates.length; i++) {
            var lineStringArray = [];
            for(var j = 0; j < lineCoordinates[i].length; j++) {
                lineStringArray.push(
                    new OpenLayers.Geometry.Point(lineCoordinates[i][j].lon, lineCoordinates[i][j].lat)
                );
            }
            var line = new OpenLayers.Geometry.LineString(lineStringArray); 
            var lineFeature = new OpenLayers.Feature.Vector(line, {i}, lineStyle);
            lineFeatureArray.push(lineFeature);
            graphicLayer.addFeatures([lineFeature]);
        }
        var bengfangStyle = {
            externalGraphic: 'img/bengfang.png', 
            graphicWidth: 50, 
            graphicHeight: 21 
        };
        var qixiangzhanStyle = {
            externalGraphic: 'img/qixiangzhan.png', 
            graphicWidth: 30, 
            graphicHeight: 50
        };
        var turangzhanStyle = {
            externalGraphic: 'img/turangzhan.png', 
            graphicWidth: 30, 
            graphicHeight: 50
        };
        // 渲染水表
        for(var i = 0; i < 19; i++) {
            var pt = new OpenLayers.Geometry.Point(coordinates[i].lon, coordinates[i].lat);
            var shuibiaoStyle = {
                externalGraphic: 'img/shuibiao.png', 
                graphicWidth: 30, 
                graphicHeight: 30,
                fontSize: "14px",
                fontColor: "#ff0000",
                fontWeight: "bold",
                labelXOffset: 0,
                labelYOffset: 18,
            };
            shuibiaoStyle.label = '' + (i + 1) + '';
            var feature = new OpenLayers.Feature.Vector(pt, {i}, shuibiaoStyle);
            graphicLayer.addFeatures([feature]);
        }
        for(var i = 23; i < 42; i++) {
            var pt = new OpenLayers.Geometry.Point(coordinates[i].lon, coordinates[i].lat);
            var shuibiaoStyle = {
                externalGraphic: 'img/shuibiao.png', 
                graphicWidth: 30, 
                graphicHeight: 30,
                fontSize: "14px",
                fontColor: "#ff0000",
                fontWeight: "bold",
                labelXOffset: 0,
                labelYOffset: 18,
            };
            shuibiaoStyle.label = '' + (i - 22) + ''; 
            var feature = new OpenLayers.Feature.Vector(pt, {i}, shuibiaoStyle);
            graphicLayer.addFeatures([feature]);
        }
        // 泵房
        for(var i = 19; i < 21; i++) {
            var pt = new OpenLayers.Geometry.Point(coordinates[i].lon, coordinates[i].lat); 
            var feature = new OpenLayers.Feature.Vector(pt, {i}, bengfangStyle);
            graphicLayer.addFeatures([feature]);
        }
        // 气象站
        var pt = new OpenLayers.Geometry.Point(coordinates[21].lon, coordinates[21].lat); 
        var feature = new OpenLayers.Feature.Vector(pt, {i: 21}, qixiangzhanStyle);
        graphicLayer.addFeatures([feature]);
        // 土壤监测站
        var pt = new OpenLayers.Geometry.Point(coordinates[22].lon, coordinates[22].lat); 
        var feature = new OpenLayers.Feature.Vector(pt, {i: 22}, turangzhanStyle);
        graphicLayer.addFeatures([feature]);
        
        // 水流绘制
        var flag = 0;
        setTimeout(function(){     
            for(var i = 0; i < lineCoordinates.length; i++)
                move(0, 1, lineCoordinates[i]);
        }, 500);
        ///根据序列点坐标 进行移动 
        function move(start, end, points) {
            var x1 = points[start].lon;
            var y1 = points[start].lat; 
            var x2 = points[end].lon;
            var y2 = points[end].lat;
            var p = (y2 - y1) / (x2 - x1); //斜率
            var v = 0.0001; //速度 
            var x = points[start].lon;
            var y = points[start].lat;
            var lastFeature;
            var moving = setInterval(function () {
                //分别计算 x,y轴方向速度
                if(x1 > x2)
                    x -= (1 / Math.sqrt(1 + p * p)) * v;
                else
                    x += (1 / Math.sqrt(1 + p * p)) * v;
                if(x1 > x2)
                    y -= (p / Math.sqrt(1 + p * p)) * v;
                else
                    y += (p / Math.sqrt(1 + p * p)) * v;

                var line = new OpenLayers.Geometry.LineString([
                    new OpenLayers.Geometry.Point(x1, y1),
                    new OpenLayers.Geometry.Point(x, y),
                ]);
                var feature = new OpenLayers.Feature.Vector(line, null, {
                    strokeColor: '#271ed9',
                    strokeWidth: 5,
                });
                graphicLayer.addFeatures([feature]);
                if(lastFeature)
                    graphicLayer.removeFeatures([lastFeature]);
                lastFeature = feature;

                //图层刷新 
                // map.graphics.redraw(); 
                graphicLayer.redraw(); 
                if (Math.abs(x - x2) < 0.0001 && Math.abs(y - y2) < 0.0001) {
                    clearInterval(moving); 
                    start++; 
                    end++; 

                    if (end < points.length) 
                        move(start, end, points);
                    if(end === points.length){
                        flag++;
                    }
                    if(flag >= lineCoordinates.length){
                        lineFeatureArray[i].style.strokeColor = '#271ed9';
                        graphicLayer.redraw();
                    }
                } 
            }, 50); 
        }


        //坐标转换  
        function corTransform(lon, lat) {  
            var proj = new OpenLayers.Projection("EPSG:4326");  
            var lonlat = new OpenLayers.LonLat(lon, lat);  
            lonlat.transform(proj, this.map.getProjectionObject());  
            return lonlat;   
        }

        // 水表点击事件注册
        var selectControl = new OpenLayers.Control.SelectFeature([graphicLayer]);
        map.addControl(selectControl); 
        selectControl.activate(); 
        function featureSelected(fea) {
            var feature = fea.feature;
            console.log(feature);
            var dom = "<div><div style='width: 200px;padding: 0 15px'>"
            +"<div><h4>详细信息</h4></div>"
            +"<p>信息1</p>"
            +"<p>信息2</p>"
            +"<p>信息3</p>"
            +"<p>信息4</p>"
            +"<p>信息5</p>"
            +"</div></div>";
            var popup = new OpenLayers.Popup.FramedCloud("xx", 
                new OpenLayers.LonLat(feature.geometry.x, feature.geometry.y),
                null, dom, null, true);
            map.addPopup(popup, true);
            console.log(popup);
            selectControl.unselectAll(); 
        }
        graphicLayer.events.on({ "featureselected": featureSelected }); 
        
        map.events.register('click', null, function (e) {          
            var pos = $(map.div).offset();
            //坐标转换
            var px = new OpenLayers.Pixel(e.clientX - pos.left, e.clientY - pos.top);
            var lonlat = map.getLonLatFromPixel(px);
            alert(lonlat.lon.toFixed(5) + ";" + lonlat.lat.toFixed(5));
        })
        
        $(document).keydown(function(event){
            if(event.keyCode == 81)
                $('#pic').toggle();            
        });
    }); 
</script> 
</body> 
</html> 
